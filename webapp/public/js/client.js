!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.geopoly=n():e.geopoly=n()}(this,(function(){return function(e){var n={};function t(o){if(n[o])return n[o].exports;var s=n[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,t),s.l=!0,s.exports}return t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:o})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(t.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var s in e)t.d(o,s,function(n){return e[n]}.bind(null,s));return o},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=0)}([function(e,n,t){"use strict";t.r(n),ol.style.IconImageCache.shared.setSize(512);const o=new ol.View({center:[0,0],zoom:5}),s=new ol.Map({layers:[],target:"app-map",controls:ol.control.defaults({attribution:!1}),interactions:ol.interaction.defaults({doubleClickZoom:!1}),view:o}),i={keyup:[],keydown:[],keypress:[],hover:[],click:[],rightclick:[],contextmenu:[]};s.on("click",e=>{if(!l.smartcast_enabled&&l.key_pressed&&l.smartcastable.has(l.key_pressed))s.forEachFeatureAtPixel(e.pixel,(e,n)=>{n.keypress&&n.keypress(e,l.key_pressed)});else{let n=!1,t=e.originalEvent.ctrlKey?"CTRL":e.originalEvent.shiftKey?"SHIFT":e.originalEvent.altKey?"ALT":null;if(s.forEachFeatureAtPixel(e.pixel,(o,s)=>{s.click&&(s.click(o,t,e),n=!0)}),!n)for(let e of i.click)e(null)}}),s.getViewport().addEventListener("contextmenu",(function(e){e.preventDefault();let n=!1;if(s.forEachFeatureAtPixel(s.getEventPixel(e),(e,t)=>{t.rightclick&&(t.rightclick(e,l.key_pressed),n=!0)}),!n)for(let e of i.rightclick)e(null)}));const r={last_pointer_event:0,busy:!1};s.on("pointermove",e=>{if(r.busy)return;l.smartcast_enabled&&(l.mouse_pixel=e.pixel);let n=(new Date).getTime();if(n-r.last_pointer_event<50)return;r.last_pointer_event=n;let t=!1;if(s.forEachFeatureAtPixel(e.pixel,(e,n)=>{n.hover&&(t=!0,n.hover(e))}),!t)for(let e of i.hover)e(null)}),s.on("movestart",e=>{r.busy=!0}),s.on("moveend",e=>{r.busy=!1});let l={smartcast_enabled:!0,global_keypress:new Set([]),smartcastable:new Set([]),smartcast_happened:!1,key_pressed:null,mouse_pixel:null};document.onkeydown=function(e){const n=e.key.toUpperCase();if(l.smartcast_enabled&&l.smartcastable.has(n)){if(e.preventDefault(),l.smartcast_happened)return;l.smartcast_happened=!0,null!=l.mouse_pixel&&s.forEachFeatureAtPixel(l.mouse_pixel,(e,t)=>{t.keypress&&t.keydown(e,n)})}else l.smartcast_enabled||(e.preventDefault(),l.key_pressed=n);if(l.global_keypress.has(n)){e.preventDefault();for(let e of i.keydown)e(null,n)}},document.onkeyup=function(e){l.key_pressed=null;const n=e.key.toUpperCase();if(l.smartcast_enabled&&(l.smartcast_happened=!1),l.global_keypress.has(n)){e.preventDefault();for(let e of i.keyup)e(null,n)}};const a={},c=[],d=[];let u=0,f=0;const m={};function g(e){for(let[n,t]of e){n.reduce((e,n)=>e&&Boolean(a[n]),!0)&&t(m)}}class h{constructor(e){this.name=e,this.ctx=m}loaded(){a[this.name]=!0,++f>=u&&function(){g(c),g(d);for(let e in m)delete m[e]}()}before_loadend(e){c.push(e)}after_loadend(e){d.push(e)}finished(e){d.push(e)}}function p(e,n){void 0===a[e]&&(a[e]=!1,n.call(new h(e)))}function b(e,n){Array.isArray(e)||(e=[e]),d.push([e,n])}const v=new Set([]),y={w:512,h:512},w={};let _=null;function k(e){(_=e||{}).dim&&(y.w=_.dim[0],y.h=_.dim[1]),_.spritesheet&&(!function(e,n){const t=new Image;t.onload=()=>{t.src=e,n.sort();const o=document.createElement("canvas"),s=o.getContext("2d");o.width=y.w,o.height=y.h;for(let[e,i]of enumerate(n)){s.clearRect(0,0,y.w,y.h);let n=e%5,r=Math.floor(e/5);s.drawImage(t,n*y.w,r*y.h,y.w,y.h,0,0,y.w,y.h);let l=new Image;l.src=o.toDataURL(),v.add(i),w[i]=l}}}("/css/flags.png",_.isos),S&&(S=null),x&&(x=null))}let x=document.createElement("canvas");x.width=y.w,x.height=y.h;let S=x.getContext("2d");const C=defaultdict(list,!0);function P(e,n){return C[e].includes(n)}function T(e){return C[e]}function j(e,n){for(let t of n)C[e].push(t),C[t].push(e)}var I=null;function F(e){null==I&&(I=!Boolean(e.get("conn"))),e.get("cen")||e.set("cen",centroid(e));let n=e.get("conn");n&&(j(e.getId(),n),e.unset("conn"))}b(["map","world"],e=>{I&&function(e){p("map",(function(){fetch(`/maps/${e}.conjson`,{cache:"force-cache"}).then(e=>e.json()).then(e=>{for(let[n,t]of e)C[n].push(t),C[t].push(n);this.loaded()})}))}(world.map)});const E={not_found:new Color(0,255,255),black:new Color(0,0,0),white:new Color(255,255,255),mil_mark:new Color(150,150,150),exhausted:new Color(40,58,64),base:new Color([211,191,158]),base_edge:new Color([99,84,58])},R={AA:E.base},q=new Set([]);let A={colorscheme:"softlight"};function O(e){if("string"==typeof e)e={iso:e};else if(e.getProperties)e=e.getProperties();let n=e.iso;return n?R[n]?q.has(n)&&["softlight","hardlight"].includes(A.colorscheme)?R[n].blend(E.base,"multiply"):"inverted"==A.colorscheme?R[n].blend(E.base,"multiply"):R[n]:E.not_found:E.base}function V(e,n){let t=null;return t="inverted"==A.colorscheme?R[n]||E.base:["softlight","lineardodge","screen","darken","multiply"].includes(A.colorscheme)?E.base.blend(e,A.colorscheme):e.blend(E.base,A.colorscheme)}const D={loaded:!1,wid:null,username:null,uid:null,me:null,spectator:!1,players:{},map:null},B={};function G(e){if(D.name=e.name,D.loaded=!0,D.wid=e.wid,e.map&&(D.map=e.map),void 0!==e.turns){for(let n of Object.keys(e))D[n]=e[n];D.turns=e.turns||0,D.rounds=e.rounds||0,D.max_rounds=e.max_rounds||0,D.turn_time=e.turn_time||0}}b("world",e=>{e.world&&!D.loaded&&G(e.world),e.debug&&(window.world=D,window.countries=B),e.countries&&(D.isos=[]);for(let n of e.countries)e.players&&e.players[n.iso]&&(n.username=e.players[n.iso].username,n.division=e.players[n.iso].division),D.isos.push(n.iso),n.color&&(R[n.iso]=new Color(n.color)),B[n.iso]=n;D.isos.sort((e,n)=>{B[e].order,B[n].order})});let L=null,z=null;function M(e,n){const t=L[e];if(t.prohibit)return!1;const o=n[t.slot];if(o){const n=L[o];if(o==e)return!1;if(!n.upgrades||!n.upgrades.includes(e))return!1}if(t.requires)for(let[e,o]of Object.items(t.requires))if(o){if(n[e]!=o)return!1}else if(n[e])return!1;return!0}fetch("/js/items.json",{cache:"force-cache"}).then(e=>e.json()).then(e=>{L=e;for(let e in L)L[e].id=e});const H={};function N(e,n){let t=new ol.style.Style({stroke:new ol.style.Stroke({color:H.color||O(e.get("iso")).rgb(),width:H.width})});if(H.fill){let n=null;n="color"==H.fill||"boolean"==typeof H.fill&&H.fill?O(e.get("iso")).rgb():(H.fill="color-blend")?V(O(e.get("iso")),e.get("iso")).rgb():H.fill,t.setFill(new ol.style.Fill({color:n}))}return t}function U(e,n){return new ol.style.Style({fill:new ol.style.Fill({color:H.color||O(e.get("iso")).rgb()})})}function Y(e,n){const t=e.get("iso"),o=V(O(t),t);return new ol.style.Style({fill:new ol.style.Fill({color:o.rgb()})})}function K(e){var n=e.getCoordinates();return"Polygon"==e.getType()?[n]:n}const W=new ol.format.GeoJSON;function J(e,n,t,o){const s=(new Date).getTime();let i=defaultdict(list);for(let n of e.getFeatures()){let e=n.get("iso");if(!e||"XX"==e)continue;let t=K(n.getGeometry());for(let n of t)i[e].push(n)}const r=new Worker("/engine/modules/borders/worker.js");let l=0;r.onmessage=function(e){const i=W.readFeature(e.data.polygon,{featureProjection:ol.proj.get("EPSG:3857"),dataProjection:"EPSG:3857"}).getGeometry();if(n(e.data.iso,i),o){let n=12,t=611;o(e.data.iso,function(e,n){switch(e.getType()){case"Polygon":var t=e.getCoordinates(),o=e.getLinearRing(0).getArea()<0?-1:1;return t[0]=ol.coordinate.offsetCoords(t[0],o*n),new ol.geom.Polygon(t);case"LineString":t=e.getCoordinates();return t=ol.coordinate.offsetCoords(t,n),new ol.geom.LineString(t);default:return console.error("Bad geometry >:("),e}}(i,n*t))}0==--l&&t((new Date).getTime()-s)};for(let e in i)try{++l,r.postMessage({iso:e,polygons:i[e]})}catch(n){console.error("  Skipped poly",e,n)}}const X={},Z=new ol.source.Vector;function Q(e,n){let t=new ol.Feature({iso:e,geometry:null});t.setId(e),t.setGeometry(n),Z.addFeature(t)}function ee(e,n){let t=new ol.Feature({iso:e,geometry:null});t.setId(e),t.setGeometry(n),X["border-instroke"]&&X["border-instroke"].getSource().addFeature(t)}function ne(e){console.info("Borders generated in",e,"seconds");for(let[e,n]of Object.items(X))n.changed()}const te=new ol.layer.Tile({source:new ol.source.Stamen({layer:"watercolor"})});te.name="watercolor";const oe=new ol.source.Vector,se=new ol.layer.Vector({source:oe,style:function(e){if(e.get("hide"))return null;let n=e.getGeometry().getCoordinates(),t=Math.atan2(n[1][1]-n[0][1],n[1][0]-n[0][0]),o=Math.PI/2-t,s=e.get("content")||"",i=O(e.get("iso"));return[new ol.style.Style({stroke:new ol.style.Stroke({color:i.rgb(),width:8}),text:new ol.style.Text({text:str(s),fill:new ol.style.Fill({color:"white"}),stroke:new ol.style.Stroke({color:"black",width:3}),font:'16px "Opera Lyrics"'})}),new ol.style.Style({image:new ol.style.Icon({src:"/img/map/arrow.png",rotation:o}),geometry:new ol.geom.Point(n[1])})]}});se.name="arrows";let ie=0;function re(e){let n=[];for(let t of ke.getFeatures())e&&!e(t)||n.push(t);++ie>=n.length&&(ie=0);let t=n[ie];return gui.infobar("area",t),function(e,n){if(!Array.isArray(e)){if(!(e instanceof ol.Feature))e=ke.getFeatureById(e);e=e.get("cen")}n?o.animate({center:e,duration:920,easing:ol.easing.inAndOut}):o.animate({center:e,duration:100,easing:ol.easing.inAndOut})}(t,!0)}const le=new ol.Feature({rotation:0,hide:!0,locked:!1,geometry:new ol.geom.LineString([[0,0],[0,0]])});function ae(e){return!(le.get("locked")&&!e)&&(le.set("locked",!1),le.set("hide",!0),!0)}function ce(e){console.info("reset game entities");for(let[e,n]of Object.items(B))n.pop=0,n.stats={conquers:0,losses:0,income:0};for(let n of ke.getFeatures()){const t=n.get("iso"),o=n.get("iso2");t&&B[t]&&(n.get("unit")&&(B[t].pop-=1,!e&&n.get("exhaust")>0&&n.set("exhaust",n.get("exhaust")-1)),n.get("dead")&&n.set("dead",!1),"city"==n.get("tile")&&(o!=t&&(B[t]&&(B[t].stats.conquers+=1),B[o]&&(B[o].stats.losses+=1)),n.set("iso2",n.get("iso")),"house"==n.get("build")?(B[t].pop+=1,B[t].stats.income+=10):"barr"==n.get("build")?(B[t].pop+=3,B[t].stats.income+=10):"cita"==n.get("build")&&(B[t].pop+=1,B[t].stats.income+=30)))}}oe.addFeature(le);const de=new function(){this.groups={},this.model={},this.subscribed={},this.reoccuring={},this.onconnected_func=[],this.ondisconnected_func=[],this.onerror_func=[],this.ws=null,this.log_style="color: purple",this.address=null,this.c_msid=1,this.trying=!1,this.request=function(e,n){if(1!=this.ws.readyState)return console.error("WebSocket is not connected"),{then:()=>{}};if(n||"string"==typeof e)n||(n={}),n.route=e;else n=e;n.route||console.error("No route defined for request: ",n),n.msid=this.c_msid++,console.info(`%c<${e} (${n.msid})`,de.log_style,n);var t=JSON.stringify(n);return this.ws.send(t),new ue(e,n.msid)},this.onconnect=function(e){this.onconnected_func.push(e)},this.ondisconnect=function(e){this.ondisconnected_func.push(e)},this.onerror=function(e){this.onerror_func.push(e)},this.onmessage=function(e){if(null!=e.data)var n=JSON.parse(e.data);else n=e;try{var t=n.route.split(":"),o=de.groups[t[0]]||this;console.info("%c>"+n.route+`(${n.msid||"0"})`,"color:purple",n);try{delete(s=Object.assign({},n)).route}catch(e){var s=n}s.params&&(s=s.params),n.msid&&de.subscribed[n.msid]?(de.subscribed[n.msid].apply(o,[s]),delete de.subscribed[n.msid]):de.subscribed[n.route]&&(de.subscribed[n.route].apply(o,[s]),delete de.subscribed[n.route]),de.reoccuring[n.route]&&de.reoccuring[n.route].apply(o,[s]);var i=o[t[1]];i&&i.apply(o,[s])}catch(e){console.error(e)}},this.on=function(e,n){this.reoccuring[e]=n},this.connect=function(e,n){this.address=e;try{this.ws=new WebSocket(e)}catch(e){for(let e of de.ondisconnected_func)e();return}this.ws.onopen=function(e){console.info("%cConnected to websocket",de.log_style);for(let e of de.onconnected_func)e();n()},this.ws.onerror=function(e){if(1==this.ws.readyState)for(let e of de.onerror_func)e();else{console.info("%cError with connecting to websocket",de.log_style),de.trying=!1;for(let e of de.ondisconnected_func)e()}},this.ws.onclose=function(e){console.info("%cDisconnected from websocket",de.log_style),de.trying=!1;for(let e of de.ondisconnected_func)e()},this.ws.onmessage=this.onmessage},this.reconnect=function(e){de.trying||de.tryReconnect(1,e)},this.tryReconnect=function(e,n,t,o){if(null==e)e=1;0!=e?de.ws.readyState!==de.ws.OPEN&&(de.trying||(de.trying=!0,console.info("%cTrying to reconnect..",de.log_style),null!=o&&o(),de.connect(de.address,(function(){de.trying=!1,console.info("%cReconnect successful",de.log_style),null!=n&&n()}))),setTimeout(()=>{de.tryReconnect(e--)},4e3)):null!=t&&t()}};var ue=function(e,n){this.then=function(e){de.subscribed[n]=e}};let fe=de,me=fe;function ge(e,n){const t={route:e,params:n};switch(e){case"Game:move":t.params.events={conquer:!1,kill:!1},me.onmessage(t);break;case"Game:buy":let o=L[n.item_id];t.params.cost={gold:o.cost_gold,pop:o.cost_pop},me.onmessage(t);break;default:console.info(e,"called with",n)}}const he={controllers:{},groups:{},ws:fe,init_game_client:function(e,n,t){this.conf=e,e.websocket?(this.ws.groups=this.groups,this.ws.connect(e.ws_address,()=>{this.request_auth(n,t)}),this.ws.onerror(e=>{console.error(e)}),this.ws.ondisconnect(e=>{"disconnect"!=gui.opened&&gui.dialog("disconnect","reconnect"),this.ws.tryReconnect(1,()=>{this.request_auth(n,()=>{gui.$refs["dialog-disconnect"].onReconnect()})},()=>{gui.$refs["dialog-disconnect"].onFailed()},()=>{gui.$refs["dialog-disconnect"].onAttempt()})})):this.ws.request=ge,e.debug&&(window.client=he)},request_auth:function({uid:e,token:n},t){const o=this.ws.request("Users:auth_token",{uid:e,token:n});null!=t&&o.then(t)}};function pe(e,n){gui.flash(e,"white",n),e=`[#${D.rounds}] <span class="small">${e}</span>`,gui.$refs["global-chat"].add_message({msg:e,iso:n,username:void 0})}const be={invalid_params:"invalid_params",cant_move_more:"You have already moved with this figure.",not_enemy:"Figure is not an enemy.",cant_attack_cavalry:"Cavalry can't attack forest.",cant_attack_there:"Can't attack there.",cant_move_there:"Can't move there.",not_your_turn:"It's not your turn."};const ve={selected:null,disable_tooltip:!1};function ye(e){if(!e)return ve.selected=null,void ae();if(ve.selected)_e(ve.selected,e)?(title.update(""),he.ws.request("Game:move",{area_id:ve.selected.getId(),to_id:e.getId()})):gui.flash("Can't move there","danger",world.me),ae(),ve.selected=null;else{const n=e.get("iso"),t=e.get("unit"),o=e.get("exhaust")>0;if(world.me==n&&t){if(o)return;!function(e,n,t){le.set("iso",e.get("iso")),le.set("hide",!1),t&&le.set("locked",!0);let o=le.getGeometry(),s=o.getCoordinates();s[0]=e.get("cen"),n?s[1]=n.get("cen"):(le.set("hide",!0),s[1]=e.get("cen")),o.setCoordinates(s)}(e),ve.selected=e}else console.log("Clicked on empty area",e.getId())}}function we(e){ve.selected&&(null!=e&&_e(ve.selected,e)?function(e){if(le.set("locked"))return;le.set("hide",!1);let n=le.getGeometry(),t=n.getCoordinates();t[1]=e.get("cen"),n.setCoordinates(t)}(e):ae())}function _e(e,n){const t=e.get("unit")||null,o=e.get("iso"),s=n.get("unit")||null,i=n.get("iso");return!e.get("exhaust")&&(s&&o!=i&&o?"inf"==t?P(e.getId(),n.getId()):function(e,n){const t=T(e);if(t.includes(n))return!0;for(let e of t)if(T(e).includes(n))return!0;return!1}(e.getId(),n.getId()):!s&&P(e.getId(),n.getId()))}he.ws.on("Game:move",({err:e,iso:n,area_id:t,to_id:o,events:s})=>{if(e)return void pe(be[e]||"unknown error: "+e,n);const i=ke.getFeatureById(t),r=ke.getFeatureById(o),l=r.get("iso"),a=r.get("unit");!function(e,n){let t=n.get("tile");n.get("unit")&&"art"==e.get("unit")?(n.set("unit",null),n.set("dead",!0),e.set("exhaust",1)):(n.set("unit",e.get("unit")),n.set("iso",e.get("iso")),e.set("unit",null),e.set("exhaust",0),n.set("exhaust","mount"==t?3:"forest"==t?2:1))}(i,r),l!=n&&("city"==r.get("tile")&&function(e,n){const t=B[e];t.stats.conquers+=1;const o=B[n];o&&o.shields>0&&(o.shields-=1),t.shields+=1}(n,l),a&&function(e){B[e]&&(B[e].pop+=1)}(l))});const ke=new ol.source.Vector({format:new ol.format.GeoJSON,url:`/maps/${window.world_map}.geojson`}),xe=new ol.layer.Vector({source:ke,style:(e,n)=>{const t=[],o=(e.get("selected"),e.get("hovered")),s=new ol.geom.Point(e.get("cen")),i=(e.get("id"),O(e)),r=function(e){return e.blend(E.base,"multiply")}(i);let l=V(i,e.get("iso"));t.push(new ol.style.Style({stroke:new ol.style.Stroke({color:E.base_edge.rgb(),width:1}),fill:new ol.style.Fill({color:o?r.rgb():l.rgb()})})),o&&t.push(new ol.style.Style({text:new ol.style.Text({text:e.get("name"),fill:new ol.style.Fill({color:r.rgb()}),stroke:new ol.style.Stroke({color:r.contrast(),width:3}),font:'14px "Opera Lyrics"',offsetY:28}),geometry:s}));const a=e.get("tile"),c=e.get("build");if(c||a){const e=c?"build-"+c:"tile-"+a;t.push(new ol.style.Style({image:new ol.style.Icon({color:o?r.shade(-.5).rgb():l.shade(-.5).rgb(),src:`/img/map/${e}.png`,scale:.4}),geometry:s}))}const d=e.get("unit"),u=e.get("dead");if(d||u){const n=e.get("exhaust")>0;let s=o?d+"-mark":d;!d&&u&&(s="dead"),t.push(new ol.style.Style({image:new ol.style.Icon({src:`/img/map/unit-${s}.png`,scale:.4,color:n?E.exhausted.rgb():void 0}),geometry:new ol.geom.Point(e.get("cen"))}))}return t}});xe.name="areas",xe.click=(e,n)=>{if(e){if("CTRL"==n)return void test_action(e);ye(e)}else ye(null)},xe.rightclick=(e,n)=>{if(e){const n=e.get("iso");D.me==n?"city"==e.get("tile")?gui.infobar("buy-units",e,D):gui.infobar("buy-tiles",e,D):gui.infobar("area",e,D)}},xe.keydown=(e,n)=>{"ESCAPE"==n?(ye(null),gui.opened&&gui.quit(gui.opened)):"SPACE"==n||" "==n?re(e=>e.get("iso")==D.me&&"city"==e.get("tile")):"TAB"==n&&(gui.opened||gui.infobar("countries"))},xe.keyup=(e,n)=>{"TAB"==n&&gui.quit("infobar-countries")};let Se=null;xe.hover=e=>{Se&&(Se.set("hovered",!1),Se=null),e&&(e.set("hovered",!0),Se=e),we(e)},p("map",(function(){var e=ke.on("change",n=>{"ready"==ke.getState()&&len(ke.getFeatures())>0&&(ol.Observable.unByKey(e),this.loaded())})}));const Ce=function(e,n){for(let e in n)H[e]=n[e];return"border-stroke"==e?X[e]=new ol.layer.Vector({maxResolution:n.maxResolution,minResolution:n.minResolution,source:Z,style:N}):"border-fill"==e?X[e]=new ol.layer.Vector({maxResolution:n.maxResolution,minResolution:n.minResolution,source:Z,style:U}):"border-instroke"==e&&(X[e]=new ol.layer.Vector({maxResolution:n.maxResolution,minResolution:n.minResolution,source:new ol.source.Vector,style:Y})),X[e]}("border-stroke",{width:4,fill:"color-blend"});Ce.click=(e,n,t)=>{if(e)if(n)"CTRL"==n&&test_action(e);else{let n=e.get("iso");gui.overlay("country",t.coordinate,B[n])}else gui.overlay("close")},Ce.keydown=(e,n)=>{"ESCAPE"==n&&gui.overlay("close")};Vue.component("infobar-header",{template:'\n\n\n  <div @mousedown="infobar_mousedown" @mouseup="infobar_mouseup" @mousemove="infobar_mousemove($event, infobar_id)" class="infobar-header" :style="iso ? area_background(iso) : \'\'">\n    <div v-if="iso" :class="\'flag flag-inline flag-xs flag-box flag-\'+iso"></div>\n\n    {{ content }}\n\n    <button type="button" class="close" aria-label="Close" @click="close_infobar(infobar_id)">\n      <span aria-hidden="true">&times;</span>\n    </button>\n  </div>\n\n',props:{content:{default:""},iso:{default:null},infobar_id:{default:""}}});Vue.component("chat-gui",{template:'\n<div v-if="show">\n  \n  <div class="d-flex">\n    <div class="p-2 flex-fill">\n      \n      <div class="chat-messages-wrapper">\n\n        \x3c!-- list of messages --\x3e\n        <div class="scroll chat-messages">\n          <div v-for="message in messages" class="chat-message">\n            <strong v-if="config.msg_show_country && message.iso && config.country_style == \'iso\'" :style="style_get_color(message.iso)">[{{message.iso}}]</strong> \n            <div v-else-if="config.msg_show_country && message.iso && config.country_style == \'flag\'" :class="\'flag flag-inline flag-xs flag-\'+message.iso"></div>\n            <div v-else-if="config.msg_show_country && message.iso && config.country_style == \'herald\'">NO_HERALD</div>\n\n            <strong v-if="config.msg_show_username && message.username" :style="style_get_color(message.iso)">{{message.username}}:</strong> \n\n            <span v-html="message.msg"></span>\n          </div>\n        </div>\n        \n      </div>\n\n    </div>\n    <div class="p-2">\n\n      \x3c!-- online users --\x3e\n      <div v-for="(username,iso) in online" class="chat-user">\n        <strong v-if="config.prof_show_country && iso && config.country_style == \'iso\'" :style="style_get_color(iso)">[{{iso}}]</strong> \n        <div v-else-if="config.prof_show_country && iso && config.country_style == \'flag\'" :class="\'flag flag-inline flag-xs flag-\'+iso"></div>\n        <div v-else-if="config.prof_show_country && iso && config.country_style == \'herald\'">NO_HERALD</div>\n\n        <strong v-if="config.prof_show_username && username" :style="style_get_color(iso)">{{username}}</strong> \n      </div>\n      \n    </div>\n  </div>\n\n  \x3c!-- Bottom inputs --\x3e\n  <div class="">\n    <div class="input-group">\n      <input ref="inputter" class="form-control chat-input" v-model="msg_input" v-on:keydown.enter="on_submit" v-on:keydown.stop=""  />\n\n      <div class="input-group-append">\n        <button v-on:click="on_submit" class="btn btn-outline-warning" type="button">Send</button>\n      </div>\n    </div>\n  </div>\n\n</div>\n',props:["roomId"],data:function(){return{show:!0,config:{},prev_iso:null,msg_input:"",messages:[],online:{},actions:{},emojis:{}}},created:function(){fe.connected&&this.sub()},methods:{sub:function(){fe.request("Chat:subscribe",{room_id:this.roomId}).then(({messages:e,users:n})=>{this.show=!0,this.messages.splice(0,this.messages.length);for(let n of e)this.add_message(n);this.online={};for(let e of n)this.add_user(e,B[e].username)}),fe.on("Chat:message",({room_id:e,msg:n})=>{this.add_message(n)}),fe.on("Chat:subscribed",({username:e,iso:n})=>{this.add_user(n,e)}),fe.on("Chat:unsubscribed",({username:e,iso:n})=>{delete this.online[n]}),this.config.toggle_on_enter&&(window.removeEventListener("keydown",this.onkey),window.addEventListener("keydown",this.onkey))},onkey:function(e){13===e.keyCode&&(this.show||(this.show=!0),Vue.nextTick(()=>{this.$refs.inputter&&this.$refs.inputter.focus()}))},add_message:function(e){let n=e.msg.match(/\:([a-z0-9\s\_\-]*.)\:/gi);if(n)for(let t of n)t=t.substr(1,t.length-2),this.emojis[t]&&(e.msg=e.msg.replace(":"+t+":",`<img title=":${t}:" class="chat-emoji" gicon=":${t}:" src="/img/chat/${this.emojis[t]}" />`));this.messages.push(e),setTimeout(()=>{var e=this.$el.querySelector(".chat-messages");e.scrollTop=e.scrollHeight},10)},add_user:function(e,n){this.online[e]&&!n||(this.online[e]=n||null)},on_submit:function(){if(""==this.msg_input)return void(this.show&&this.config.toggle_on_enter&&(this.show=!1));let e=this.msg_input.match(/\/([a-z0-9\s\_\-]*.)/gi);if(e)for(let n of e)n=n.substr(1,n.length-1),this.actions[n]&&this.actions[n](this.msg_input);else fe.request("Chat:message",{room_id:this.roomId,msg:this.msg_input});this.msg_input=""},style_get_color:function(e){return"color: "+O(e).rgb()}},watch:{messages:function(){}}});Vue.component("dialog-players",{template:'\n<div v-if="show">\n  <div class="modal" style="display: block">\n    <div class="modal-dialog modal-xl" role="document">\n      <div class="modal-content">\n        <div class="modal-header">\n          <h5 class="modal-title">Players</h5>\n\n          <button type="button" class="close" aria-label="Close" @click="$emit(\'close\')">\n            <span aria-hidden="true">&times;</span>\n          </button>\n        </div>\n        <div class="modal-body scroll" :style="maxHeight">\n\n          <div class="row">\n            <div class="col-lg-2 col-md-3 col-sm-4 col-xs-6 pointer" v-for="country in countries" v-on:click="onClicked(country.iso)">\n\n              <div>\n                <span :class="\'flag flag-md flag-inline flag-\' + country.iso + (country.username?\'\':\' flag-unclaimed\')"></span>\n\n                <div></div>\n\n                <h5 class="card-title">{{ country.name }}</h5>\n                <p v-if="country.username">{{ country.username }}</p>\n              </div>\n\n            </div>\n          </div>\n\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n',data:function(){return{show:!1,countries:B}},created:function(){},methods:{open:function(){},onClicked:function(){}}});Vue.component("infobar-countries",{template:'\n  <div v-if="show" class="infobar infobar-lg">\n    <infobar-header content="Countries" infobar_id="countries"></infobar-header>\n    \n    <div class="infobar-content font-oldie p-2">\n\n      <table class="table table-borderless table-hover table-sm text-center">\n        <thead>\n          <tr>\n            <td></td>\n            <td></td>\n            <td></td>\n            <td><i class="ra ra-2x ra-shadow ra-shadow ra-res-gold"></i></td>\n            <td><i class="ra ra-2x ra-res-pop"></i></td>\n            <td><i class="ra ra-2x ra-shadow ra-res-shield"></i></td>\n            <td><i class="ra ra-2x ra-shadow ra-icon-conquer"></i></td>\n          </tr>\n        </thead>\n        <tbody>\n          <tr @click="open_infobar(\'country\', country)" v-for="(country, iso) in countries" :class="{\'pointer\': true, \'table-active\': world.current == iso, \'strikeout\': country.shields <= 0}">\n            <td>\n              <i v-if="world.current == iso" class="ra ra-lg ra-shadow ra-icon-current"></i>\n            </td>\n            <td>\n              <div :class="\'flag flag-xs pointer flag-box flag-\'+iso+(country.shields <=0?\' flag-unclaimed\':\'\')" v-b-popover.hover.top="country.name" ></div>\n            </td>\n            <td>\n              <i v-if="country.emperor" class="ra ra-2x ra-shadow ra-icon-emperor"></i>\n              <i v-else-if="max_conquers > 0 && max_conquers == country.stats.conquers" class="ra ra-2x ra-shadow ra-icon-topscore"></i>\n            </td>\n            <td>{{ country.gold }}</td>\n            <td>{{ country.pop }}</td>\n            <td>{{ country.shields }}</td>\n            <td>{{ country.stats.conquers }}</td>\n          </tr>\n        </tbody>\n      </table>\n\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,countries:B,world:D}},methods:{open:function(e){this.infobar_id="countries"}},computed:{max_conquers:function(){let e=0;for(let n in B)(!e||B[n].stats.conquers>e)&&(e=B[n].stats.conquers);return e}}});Vue.component("infobar-country",{template:'\n  <div v-if="show" class="infobar infobar-lg font-oldie">\n    <infobar-header :content="country.name" :iso="country.iso" infobar_id="country"></infobar-header>\n\n    <div class="infobar-content p-2" :country-iso="country.iso">\n\n      <div class="d-flex">\n        <div class="flex-fill">\n          \x3c!-- Economy --\x3e\n          <div>\n            <i class="ra ra-2x ra-shadow ra-shadow ra-res-gold"></i> {{ country.gold }} (+{{ country.stats.income }})\n          </div>\n          <div>\n            <i class="ra ra-2x ra-res-pop"></i> {{ country.pop }}\n          </div>\n          <div>\n            <i class="ra ra-2x ra-shadow ra-res-shield"></i> {{ country.shields }}\n          </div>\n          <div>\n            <i class="ra ra-2x ra-shadow ra-icon-conquer"></i> {{ country.stats.conquers }} (-{{ country.stats.losses }})\n          </div>\n\n        </div>\n        <div class="flex-fill">\n          \x3c!-- Player --\x3e\n          <div v-if="country.username">\n            <div class="rank-box">\n              <i :class="\'ra ra-2x ra-rank-\'+country.division"></i>\n            </div>\n\n            <strong :style="area_color(country)">{{ country.username }}</strong>\n          </div>\n          <div v-else>\n            <p class="small">No player</p>\n          </div>\n        </div>\n      </div>\n\n      <hr />\n\n      \x3c!-- Send tribute --\x3e\n      <div class="form-group">\n        <p class="small">Send Tribute:</p>\n\n        <div class="input-group">\n          <input type="text" class="form-control" style="max-width: 100px;" v-model.number="tribute" placeholder="Tribute amount">\n\n          <div class="input-group-append">\n            <button @click="onTribute" class="btn btn-outline-success" type="button">\n              <i class="ra ra-lg ra-icon-tribute"></i>\n              <span style="color:#2e4e0a">Send</span>\n            </button>\n          </div>\n        </div>\n      </div>\n\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,dragging:!1,tribute:0,country:null}},methods:{open:function(e){e.getProperties&&(e=e.getProperties()),this.country=e,this.infobar_id="country"},onTribute:function(){fe.request("Game:tribute",{iso:this.country.iso,amount:this.tribute}),this.tribute=0}},computed:{}});Vue.component("item-box",{template:'\n\n\n<div @click="disabled ? null : $emit(\'buy\', item)" :class="{\'card\': true, \'pointer\': !disabled, \'bg-secondary\': disabled}">\n  <div class="card-body">\n   <div class="text-center">\n      <i :class="\'ra ra-4x ra-\'+item.slot+\'-\'+item.id"></i>\n    </div>\n\n    <p class="card-text"><b :class="item.color">{{item.name}}</b> {{item.description}}<br/> \n      <span v-for="res in resources" v-if="item[\'cost_\'+res] > 0"><i :class="\'ra ra-res-\'+res"></i> {{ item[\'cost_\'+res] }}</span>\n    </p>\n\n  </div>\n</div>\n\n',props:{item_id:{default:null},item_conf:{default:null},disabled:{default:!1}},data:function(){return{resources:z.resources,item:{}}},watch:{item_id:{immediate:!0,handler:function(e){null!=e&&(this.item=L[e])}},item_conf:{immediate:!0,handler:function(e){null!=e&&(this.item=e)}}}});Vue.component("build-catalog",{template:'\n\n<div>\n  <div class="row">\n    <div v-for="item in items" :class="\'col-\'+col_size">\n\n      <item-box @buy="$emit(\'buy\', item)" :item_id="item.id" :disabled="!can_afford(item.id, parent)"></item-box>\n    </div>\n  </div>\n\n</div>\n\n',props:{parent:{default:null},entity:{default:null},col_size:{default:4},item_slot:{default:""}},data:function(){return{items:[]}},methods:{change_items:function(){this.items=[];for(let[e,n]of Object.items(L))n.slot==this.item_slot&&M(e,this.entity)&&this.items.push(n)},can_afford:function(e,n){const t=L[e];for(let e of z.resources)if(t["cost_"+e]>n[e])return!1;return!0}},watch:{entity:{immediate:!0,handler:function(){this.change_items()}},parent:{immediate:!0,handler:function(){this.change_items()}},item_slot:{immediate:!0,handler:function(){this.change_items()}}}});const Pe={inf:"infantry",cav:"cavalry",art:"artillery",barr:"barracks",house:"house",cita:"citadel",river:"river",bridge:"bridge",forest:"forest",city:"settlement"};Vue.component("infobar-area",{template:'\n  <div v-if="show" class="infobar infobar-lg font-oldie">\n    <infobar-header :content="area.name + \' - info\'" :iso="area.iso" infobar_id="area"></infobar-header>\n\n    <div class="infobar-content p-2" :area-id="area.id">\n\n      <div class="d-flex">\n        <div class="flex-fill">\n          <p v-if="area.unit">\n            <span :class="\'ra ra-lg ra-unit-\'+area.unit"></span> {{ item_name(area.unit) }}\n\n            <br/>\n            <strong v-if="area.unit && area.exhaust" class="small">Exhausted for {{ area.exhaust }} rounds.</strong>\n          </p>\n          <p v-if="area.build">\n            <span :class="\'ra ra-lg ra-build-\'+area.build"></span> {{ item_name(area.build) }}\n          </p>\n          <p v-if="area.tile">\n            <span :class="\'ra ra-lg ra-tile-\'+area.tile"></span> {{ item_name(area.tile) }}\n          </p>\n\n        </div>\n        <div class="flex-fill">\n          <p v-if="country"> \n            <span @click="open_infobar(\'country\', country)" :class="\'flag flag-xs flag-box pointer flag-\'+country.iso"></span> {{ country.name }}\n\n            <br />\n            <strong v-if="country.username">({{ country.username }})</strong>\n          </p>\n\n          <p v-if="area.iso2 && area.iso != area.iso2">Was annexed from <span :class="\'flag flag-xs flag-box flag-\'+area.iso2"></span></p>\n\n        </div>\n      </div>\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,area:{},country:{}}},methods:{open:function(e){e.getProperties&&(e=e.getProperties()),this.area=e,this.country=B[e.iso],this.infobar_id="area-"+e.id},item_name:function(e){return Pe[e].title()}}});Vue.component("infobar-buy-tiles",{template:'\n  <div v-if="show" class="infobar infobar-lg font-oldie">\n    <infobar-header :content="area.name + \' - build\'" :iso="area.iso" infobar_id="buy-tiles"></infobar-header>\n\n    <div class="infobar-content p-2" :area-id="area.id">\n      <strong>Build area:</strong>\n\n      <build-catalog @buy="onBuy" item_slot="tile" col_size.number="4" :parent="country" :entity="area"></build-catalog>\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,area:{},country:{}}},methods:{open:function(e){e.getProperties&&(e=e.getProperties()),this.area=e,this.country=B[e.iso],this.infobar_id="buy-tiles-"+e.id},onBuy:function(e){fe.request("Game:buy",{area_id:this.area.id,item_id:e.id}),this.show=!1}},computed:{}});Vue.component("infobar-buy-units",{template:'\n  <div v-if="show" class="infobar infobar-lg font-oldie">\n    <infobar-header :content="area.name + \' - buy\'" :iso="area.iso" infobar_id="buy-units"></infobar-header>\n\n    <div class="infobar-content p-2" :area-id="area.id">\n      <strong>Buy soldier or building:</strong>\n\n      <build-catalog @buy="onBuy" item_slot="unit" col_size.number="4" :parent="country" :entity="area"></build-catalog>\n\n      <build-catalog @buy="onBuy" item_slot="build" col_size.number="4" :parent="country" :entity="area"></build-catalog>\n\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,area:{},country:{}}},methods:{open:function(e){e.getProperties&&(e=e.getProperties()),this.area=e,this.country=B[e.iso],this.infobar_id="buy-units-"+e.id},onBuy:function(e){fe.request("Game:buy",{area_id:this.area.id,item_id:e.id}),this.show=!1}},computed:{}});Vue.component("dialog-settings",{template:'\n<div v-if="show">\n  <div class="modal" style="display: block">\n    <div class="modal-dialog" role="document">\n      <div class="modal-content">\n        <div class="modal-header">\n          <h5 class="modal-title">Map settings</h5>\n\n          <button type="button" class="close" aria-label="Close" @click="$emit(\'close\')">\n            <span aria-hidden="true">&times;</span>\n          </button>\n        </div>\n        <div class="modal-body">\n          <div class="d-flex">\n\n            <div class="flex-fill">\n              <strong>Color scheme</strong>\n              \n              <div class="custom-control custom-radio">\n                <input v-model="blendmode" value="normal" :checked="blendmode == \'normal\'" type="radio" id="blendmode1" name="blendmode" class="custom-control-input">\n                <label class="custom-control-label" for="blendmode1">Faded</label>\n              </div>\n              <div class="custom-control custom-radio">\n                <input v-model="blendmode" value="lineardodge" :checked="blendmode == \'lineardodge\'" type="radio" id="blendmode2" name="blendmode" class="custom-control-input">\n                <label class="custom-control-label" for="blendmode2">Light</label>\n              </div>\n              <div class="custom-control custom-radio">\n                <input v-model="blendmode" value="screen" :checked="blendmode == \'screen\'" type="radio" id="blendmode3" name="blendmode" class="custom-control-input">\n                <label class="custom-control-label" for="blendmode3">Screen</label>\n              </div>\n              <div class="custom-control custom-radio">\n                <input v-model="blendmode" value="softlight" :checked="blendmode == \'softlight\'" type="radio" id="blendmode4" name="blendmode" class="custom-control-input">\n                <label class="custom-control-label" for="blendmode4">Softlight</label>\n              </div>\n              <div class="custom-control custom-radio">\n                <input v-model="blendmode" value="hardlight" :checked="blendmode == \'hardlight\'" type="radio" id="blendmode5" name="blendmode" class="custom-control-input">\n                <label class="custom-control-label" for="blendmode5">Hardlight</label>\n              </div>\n              <div class="custom-control custom-radio">\n                <input v-model="blendmode" value="inverted" :checked="blendmode == \'inverted\'" type="radio" id="blendmode6" name="blendmode" class="custom-control-input">\n                <label class="custom-control-label" for="blendmode6">Vivid</label>\n              </div>\n              <div class="custom-control custom-radio">\n                <input v-model="blendmode" value="multiply" :checked="blendmode == \'multiply\'" type="radio" id="blendmode7" name="blendmode" class="custom-control-input">\n                <label class="custom-control-label" for="blendmode7">Dark</label>\n              </div>\n            </div>\n          \n            <div class="flex-fill">\n              <strong>Game HUD</strong>\n\n              <div class="custom-control custom-checkbox">\n                <input v-model="smartcast" :checked="smartcast" type="checkbox" class="custom-control-input" id="smartCast1">\n                <label class="custom-control-label" for="smartCast1">Enable smartcast</label>\n              </div>\n\n              <div class="custom-control custom-checkbox">\n                <input v-model="show_flags" DISABLED :checked="show_flags" type="checkbox" class="custom-control-input" id="showflags1">\n                <label class="custom-control-label" for="showflags1">Show country flags</label>\n              </div>\n\n              <div class="custom-control custom-checkbox">\n                <input v-model="thick_borders" DISABLED :checked="thick_borders" type="checkbox" class="custom-control-input" id="thickBorders1">\n                <label class="custom-control-label" for="thickBorders1">Stylish borders</label>\n              </div>\n\n              <div class="custom-control custom-checkbox">\n                <input v-model="units3d" DISABLED :checked="units3d" type="checkbox" class="custom-control-input" id="units1">\n                <label class="custom-control-label" for="units1">3D Army figures</label>\n              </div>\n\n            </div>\n\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n',data:function(){return{show:!1,settings:{},blendmode:null,units3d:null,smartcast:null,thick_borders:null,show_flags:null}},created:function(){this.load(),this.blendmode=this.settings.blendmode||"softlight",this.smartcast=this.settings.smartcast||!0,this.show_flags=this.settings.show_flags||!0,this.units3d=this.settings.units3d||!1,this.thick_borders=this.settings.show_flags||!1},methods:{open:function(){},load:function(){this.settings=JSON.parse(Cookie.get("settings","{}"))},save:function(){Cookie.set("settings",JSON.stringify(this.settings))}},watch:{blendmode:function(e){this.settings.blendmode=e,A.colorscheme=e,xe.getSource().changed(),this.save()},smartcast:function(e){this.settings.smartcast=e,l.smartcast_enabled=e,this.save()},units3d:function(e){this.settings.units3d=e,this.save()},thick_borders:function(e){this.settings.thick_borders=e,this.save()},show_flags:function(e){this.settings.show_flags=e,xe.getSource().changed(),this.save()}}});Vue.component("dialog-game-end",{template:'\n<div v-if="show">\n  <div class="modal" style="display: block">\n    <div class="modal-dialog" role="document">\n      <div class="modal-content">\n        <div class="modal-header" :style="area_background(winner)">\n          <div :class="\'flag flag-inline flag-sm flag-box flag-\'+winner"></div>\n\n          <h1 class="modal-title" v-if="world.me == winner">Victory!</h1>\n          <h1 class="modal-title" v-else>Defeat!</h1>\n\n          <div :class="\'flag flag-inline flag-sm flag-box flag-\'+winner"></div>\n        </div>\n        <div class="modal-body">\n\n          <div v-if="world.me == winner">\n            <h5>Congratulations!</h5>\n\n            <p>You have won this game!</p>\n          </div>\n\n          <div>\n            <table class="table table-borderless table-hover table-sm">\n              <tbody>\n                <tr v-for="(country, iso) in countries" :class="{\'bg-secondary\': winner == iso}">\n                  <td><div :class="\'flag flag-xs pointer flag-box flag-\'+iso"></div></td>\n                  <td><i class="ra ra-2x ra-shadow ra-res-gold"></i> {{ country.gold }}</td>\n                  <td><i class="ra ra-2x ra-res-pop"></i> {{ country.pop }}</td>\n                  <td><i class="ra ra-2x ra-shadow ra-res-shield"></i> {{ country.shields }}</td>\n                </tr>\n              </tbody>\n            </table>\n\n            <p>The game has ended. Winner: {{ countries[winner].name }}</p>\n            <p>This match took <strong>{{ world.rounds }} rounds</strong>.</p>\n          </div>\n\n          <div>\n            <button @click="onClick"  :style="area_background(winner)" class="btn btn-block">Continue</button>\n          </div>\n\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n',data:function(){return{show:!1,winner:null,world:D,countries:B}},methods:{open:function(e){this.show=!0,this.winner=e},close:function(){this.show=!1},onClick:function(){window.location="/"}}});Vue.component("dialog-disconnect",{template:'\n<div v-if="show">\n  <div class="modal" style="display: block">\n    <div class="modal-dialog" role="document">\n      <div class="modal-content">\n        <div class="modal-header">\n          Disconnected from server\n        </div>\n        <div class="modal-body">\n          <div v-if="status == \'failed\'">\n            <strong>Couldn\'t reconnect to the server.</strong> Check if your internet is working. Try reloading the page or contact us.\n          </div>\n          <div v-else-if="status == \'reconnect\'">\n            <strong>Connecting to the server...</strong>\n\n            <span>Attempt #{{ attempts }}</span>\n          </div>\n          <div v-else-if="status == \'success\'">\n            <strong class="text-success">Successfully reconnected!</strong>\n          </div>\n          <div v-else>\n            Disconnected.\n          </div>\n\n          <br/>\n          <br/>\n          <div>\n            <button @click="onQuit" class="btn btn-secondary btn-block">Quit world</button>\n          </div>\n\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n',data:function(){return{show:!1,status:null,attempts:0}},methods:{open:function(){this.show=!0,this.attempts=0},close:function(){this.show=!1},onAttempt:function(){this.status="reconnect",this.attempts++},onFailed:function(){this.status="failed"},onReconnect:function(){this.status="success",this.attempts=0,setTimeout(()=>{this.close()},200)},onQuit:function(){alert("Feature not yet implemented")}}});Vue.component("overlay-country",{template:'\n<div v-if="show">\n\n  <div class="popover fade show bs-popover-top" role="tooltip" x-placement="right">\n    <div class="popover-header">\n      <div :class="\'flag flag-inline flag-xs flag-box flag-\'+country.iso"></div>\n\n      {{country.name}}\n\n      <button type="button" class="close" aria-label="Close" v-on:click="show=false">\n        <span aria-hidden="true">&times;</span>\n      </button>\n    </div>\n\n    <div class="popover-body">\n      yololo ka\n    </div>\n  </div>\n\n</div>\n',data:function(){return{show:!1,country:{}}},methods:{open:function(e){e.getProperties&&(e=e.getProperties()),this.show=!0,this.country=e}}});const Te={hu_test:{name:"Test Map (Hungary)",max_players:3,isos:["UK","FR","HU"],year:1921,center:[2172e3,5942e3],zoom:[5,6,8],zoom_mini:5,separate_resolution:2445},us_civil:{name:"US Civil War",max_players:2,isos:["US","CS"],year:1861,center:[-9693e3,4265500],zoom:[4,6,7],zoom_mini:3,separate_resolution:5e3},hu_revolt:{name:"Hungarian Revolution",max_players:6,isos:["AT","HU","HH","RS","SK","RO"],year:1848,center:[2172e3,5942e3],zoom:[5,6,8],zoom_mini:3},eu_napoleon:{name:"Napoleonic wars",max_players:9,isos:["UK","AT","PR","RU","FR","NL","SR","ES","PT","PO","HN"],year:1810,center:[2172e3,5942e3],zoom:[4,5,7],zoom_mini:2}},$e=1e3,je=35;let Ie=0,Fe=null,Ee=null;function Re(e,n){if(!n)return;pe(e+": "+(n.username||n.name),n.iso)}function qe({round:e,payday:n,emperor:t,ex_emperor:o,eliminated:s,orders:i}){if(D.rounds=e,ce(),n&&function(e,n){for(let[n,t]of Object.items(B))t.emperor=!1,t.gold+=e[n]||0;B[n].emperor=!0,B[n].gold+=20}(n,t),len(s)>0)for(let e of s)B[e].shields=0;t&&Ae(i)}function Ae(e){for(let[n,t]of Object.items(e))B[n].order=t;const n={};Object.keys(B).forEach(e=>{n[e]=B[e],delete B[e]});const t=Object.keys(n);t.sort((e,t)=>n[e].order-n[t].order),t.forEach(e=>{B[e]=n[e]})}window.reassign_orders=Ae,fe.on("Game:end_turn",({iso:e,turn_end:n,round_end:t})=>{if(0==len(B))return void console.error("grr >:(");D.current=n.current,D.turns=n.turns;const o=B[D.current];"countries"==gui.opened&&gui.$refs["infobar-countries"].$forceUpdate(),D.current==D.me?title.update("(1) -"):title.update("");const s=D.current;!function(e,n){Fe&&clearTimeout(Fe),Ee&&clearInterval(Ee),Ie=0,Ee=setInterval(()=>{let e=++Ie/je;e<1?n(e,je-Ie):e>=1&&clearInterval(Ee)},$e),Fe=setTimeout(()=>{Ee&&clearInterval(Ee),n(1,0)},je*$e+200)}(0,(e,n)=>{e<1?D.me==s&&gui.frame.setTurnTimeout(n):(gui.frame.setTurnTimeout(null),fe.request("Game:end_turn",{timeout:s}))}),t?(qe(t),t.emperor?(D.current!=D.me&&title.update("(New Emperor!) -"),Re("New emperor",B[t.emperor])):Re("New round starts with",o)):Re("Current turn",o)});Vue.component("game-frame",{template:'\n  <div v-if="world && world.me" >\n    <div v-if="world.me" class="gui-corner-left-wrapper">\n      <div class="gui-corner-left" @click="onClickFlag">\n        <div class="glass"></div>\n\n        \x3c!-- use this for coats of arms: --\x3e\n        \x3c!--<div class="flag-wrap">\n          <div class="flag-shield" :style="herald(world.me)"></div>\n        </div>--\x3e\n\n        <div class="flag-wrap">\n          <div :class="\'flag flag-\'+world.me"></div>\n        </div>\n      </div>\n    </div>\n\n    <div class="gui-corner-right-wrapper">\n      <div class="gui-corner-right" @click="onClickSeason">\n        <div class="glass"></div>\n        <div class="season-wrap">\n          <div :class="\'season season-\' + season">\n            <span class="year-text text-oldie">{{ gameyear }}</span>\n\n            <span class="day-text text-oldie">{{ gamedate }}</span>\n          </div>\n        </div>\n      </div>\n\n\n      <div title="" @click="open_infobar(\'countries\')" class="gui-corner-icon tilt-0">\n        <i class="ra icon-ra ra-icon-player"></i>\n      </div>\n\n      <div title="" class="gui-corner-icon tilt-22_5">\n      </div>\n\n      <div title="" class="gui-corner-icon tilt-45">\n      </div>\n\n      <div title="Map settings"  @click="open_dialog(\'settings\')" class="gui-corner-icon tilt-67_5">\n        <i class="ra icon-ra ra-icon-settings"></i>\n      </div>\n\n      <div title="Surrender" @click="exit" class="gui-corner-icon tilt-90">\n        <i class="ra icon-ra ra-icon-exit"></i>\n      </div>\n    </div>\n\n\n    <div v-if="world.current == world.me && turn_time_left != null" class="gui-counter text-oldie">\n      \x3c!-- display time left of turn --\x3e\n      <span :class="{\'text-danger\': turn_time_left < 7 && turn_time_left % 2 == 0, \'text-warning\': turn_time_left < 7 && turn_time_left % 2 == 1}">{{ turn_time_left }}s</span>\n    </div>\n  </div>\n',data:function(){return{iso:"AA",world:D,turn_time_left:null,updates:0}},methods:{onClickFlag:function(e){re()},onClickSeason:function(e){this.turn_time_left=null,D.current==D.me?fe.request("Game:end_turn",{}):gui.flash("It's not your turn.","white",D.current)},setTurnTimeout(e){this.turn_time_left=e,this.$forceUpdate()},exit:function(){if(this.world.me){confirm("Are you sure you want to leave the world?")&&fe.request("Game:surrender",{}).then(()=>{window.location="/"})}else window.location="/"}},computed:{season:function(){let e=this.world.turns%12+1;return e<=2||12==e?"Winter":3<=e&&e<=5?"Spring":6<=e&&e<=8?"Summer":9<=e&&e<=11?"Fall":"Rawr XD"},gameyear:function(){return Te[this.world.map].year+Math.floor(this.world.turns/12)},gamedate:function(){let e=this.gameyear,n=this.world.turns%12+1,t=function(e,n){const t=2147483648;let o=e||Math.floor(Math.random()*(t-1));return o=(1103515245*o+12345)%t,o/=t-1,round(o)*(2==n?30:28)}(this.world.turns);n=("0"+n).slice(-2),t=("0"+t).slice(-2);let o=new Date(e+"-"+n+"-"+t+"T01:00:00");return o.toLocaleString("en-US",{month:"short"})+" "+o.getDate()}}});Vue.component("flash",{template:'\n<div v-if="show" id="flash">\n  <div class="gui-flash-wrapper">\n    <div class="gui-flash">\n      <div :class="\'flag flag-inline flag-box flag-sm flag-\'+iso"></div> \n\n      <div class="gui-flash-text">\n        <span :class="\'gui-text text-\'+theme">{{ text }}</span>\n      </div>\n    </div>\n  </div>\n</div>\n',data:function(){return{show:!1,iso:null,theme:"danger",text:null,timeout:null}},methods:{display:function(e,n,t){this.theme=n||"white",this.text=e,this.iso=t,this.show=!0,this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.timeout=setTimeout(()=>{this.show=!1,this.text=null},7500)}}});let Oe=[0,0],Ve=!1;const De={open_dialog:function(e,...n){gui.dialog(e,...n)},open_infobar:function(e,...n){gui.infobar(e,...n)},close_infobar:function(e){gui.quit("infobar-"+e)},infobar_mousedown:function(e){Ve=!0;const n=e.target.parentElement;Oe=[n.offsetLeft-e.clientX,n.offsetTop-e.clientY]},infobar_mouseup:function(e){Ve=!1},infobar_mousemove:function(e,n){if(e.preventDefault(),Ve){const t=e.target.parentElement,o=e.clientX+Oe[0],s=e.clientY+Oe[1];t.style.left=o+"px",t.style.top=s+"px",gui.infobar_lastpos[n]=[o,s]}},maxHeight:function(){return"max-height: "+($("#app-map").offsetHeight-220)+"px;"},area_color:function(e){return"color: "+O(e).contrast()+";"},area_background:function(e){var n=O(e);return"background: "+n.rgba()+";"+("color: "+n.contrast()+";")},unit_background:function(e){let n=O(e);for(;"black"==n.contrast();)n=n.shade(-.15);return"background: "+n.rgba()+";"+("color: "+n.contrast()+";")},herald:function(e){let n;if(n="string"==typeof e?e:e.get||e.getProperties?e.get("iso"):e.iso,v.has(n))var t="background-image: "+("url('/img/flags/flag_"+n+".png')")+";background-position:center;";else t="background-color: "+O(e).rgb()+";";return t}};let Be={},Ge={};$("#app-gui").innerHTML&&(Be=new Vue({el:"#app-gui",data:{opened_comp:null,opened:null,opened_type:null,infobar_lastpos:defaultdict(list,!0)},methods:{child:function(e){return this.$refs[e]},infobar:function(e,...n){this.opened_comp&&"infobar"!=this.opened_type&&(this.opened_comp.show=!1,this.opened=null,this.opened_type=null);let t=this.$refs["infobar-"+e];if(t){if(t.open(...n),t.show=!0,this.opened_comp=t,this.opened=e,this.opened_type="infobar",Be.infobar_lastpos[Be.opened]){const[e,n]=Be.infobar_lastpos[Be.opened];Vue.nextTick(()=>{t.$el.style.left=e+"px",t.$el.style.top=n+"px"})}return t}},dialog:function(e,...n){this.opened_comp&&"infobar"!=this.opened_type&&(this.opened_comp.show=!1,this.opened=null,this.opened_type=null);let t=this.$refs["dialog-"+e];if(t)return t.open(...n),t.show=!0,this.opened_comp=t,this.opened=e,this.opened_type="dialog",t},overlay:function(e,n,...t){this.opened_comp&&"infobar"!=this.opened_type&&(Ge[this.opened]&&Ge[this.opened].setPosition(void 0),this.opened_comp.show=!1,this.opened=null,this.opened_type=null);let o=this.$refs["overlay-"+e];if(o){if(o.open(...t),o.show=!0,this.opened_comp=o,this.opened=e,this.opened_type="overlay",Ge[e])Ge[e].setPosition(n);else{const t=new ol.Overlay({element:Be.$refs["overlay-"+e].$el,position:n,autoPan:!0,autoPanAnimation:{duration:250}});map.addOverlay(t),Ge[e]=t}return o}},flash:function(e,n,t){this.$refs.flash.display(e,n,t)},quit:function(e){if(e){const n=this.$refs[e];if(!n)return void console.error("Trying to close unknown gui element",e);n.close?n.close():n.show=!1}else for(let e in this.$refs)this.quit(e);(this.opened_comp||this.opened)&&(this.opened_comp=null,this.opened=null)}},computed:{frame:function(){return this.$refs.frame}}})),Vue.mixin({data:function(){return{me:null,...De}}});const Le=Be,ze=new Set(["barr","house","cita"]),Me=new Set(["river","bridge","city"]),He=new Set(["inf","cav","art"]),Ne={inf:"infantry",cav:"cavalry",art:"artillery",barr:"barracks",house:"house",cita:"citadel",river:"river",bridge:"bridge",city:"settlement"},Ue={cant_buy_after_move:"You can't buy new items after you have moved in your turn.",item_exists:"Item already exists on that area.",bad_conf:"Unexpected item.",not_mine:"It's not your area.",not_enough_gold:"You don't have enough money.",not_enough_pop:"You don't have enough population. Buy more buildings.",missing_city:"You can only build over a city.",missing_river:"You can only build a bridge over rivers.",missing_:"Rawr XD",not_your_turn:"It's not your turn."};var Ye;he.ws.on("Game:buy",({iso:e,area_id:n,item_id:t,cost:o,err:s})=>{if(s)return void pe(Ue[s]||"unknown error: "+s,e);D.me==e&&title.update("");const i=ke.getFeatureById(n);null==e&&(e=i.get("iso")),function(e,{gold:n,pop:t},o){null==o&&(o=1),n&&(B[e].gold+=o*n),t&&(B[e].pop+=o*t)}(e,o,-1),He.has(t)?(i.set("unit",t),i.set("exhaust",1)):ze.has(t)?i.set("build",t):Me.has(t)&&i.set("tile",t),ke.changed();const r=B[e],l=Ne[t];pe((r.username||r.name)+" has bought "+l.title()+" on "+i.get("name"),e)}),he.ws.on("Game:tribute",({iso:e,to_iso:n,amount:t})=>{B[e].gold-=t,B[n].gold+=t;const o=B[e];pe((o.username||o.name)+" has given "+t+" golds to "+B[n].name,e)}),t.d(n,"default",(function(){return We})),s.getLayers().extend([te,xe,Ce,se]),Ye={global_keypress:new Set([" ","ESCAPE","TAB"])},s.getLayers().forEach(e=>{e.keyup&&i.keyup.push(e.keyup),e.keydown&&i.keydown.push(e.keydown),e.keypress&&i.keypress.push(e.keypress),e.hover&&i.hover.push(e.hover),e.click&&i.click.push(e.click),e.rightclick&&i.rightclick.push(e.rightclick),e.contextmenu&&i.contextmenu.push(e.contextmenu)}),l.global_keypress=Ye.global_keypress;const Ke=Te[window.world_map];function We(e,n,t,i){k(e.flags),o.setCenter(Ke.center),o.setZoom(Ke.zoom[1]),o.setMinZoom(Ke.zoom[0]),o.setMaxZoom(Ke.zoom[2]),e.client.debug&&(window.map=s,window.layers=s.getLayers(),window.areas=window.layers.item(1).getSource()),he.init_game_client(e.client,n),function(e){e&&e.wid&&(D.wid=e.wid,D.uid=e.uid,D.me=e.iso,D.username=e.username)}(n),function(e,n){"string"!=typeof e&&G(e),p("world",(function(){fetch("/worlds/load").then(e=>e.json()).then(e=>{this.ctx.world=e.world,this.ctx.countries=e.countries,this.ctx.players=e.players,n.bind(this)(e),this.loaded()})}))}(i,(function(n){this.ctx.conf=e,this.ctx.debug=e.client.debug,this.ctx.areas=n.areas}))}!function(...e){u=e.length}("world","map"),b(["world","map"],e=>{for(let n of e.areas){let e=ke.getFeatureById(n.id);e?e.setProperties(n):console.error("Missing feature:"+n.id)}const n=Te[window.world_map].separate_resolution;xe.setMaxResolution(n),Ce.setMinResolution(n),function(e){for(let n of e.getFeatures())F(n)}(ke),e.conf.borders.enabled&&(e.conf.borders.source=ke,function(e){let n=e.new_feature_func||Q,t=e.end_callback||ne,o=X["border-instroke"]||X["border-fill"]?e.new_inner_feature_func||ee:null;J(e.source,n,t,o)}(e.conf.borders)),e.conf.chat.enabled?function(e,n){e.emojis={geogine:"whead.png",geopoly:"favicon.png",geoguy:"geoguy.png",geolite:"geolite.png",geo:"logo.png",meh:"meh.png",idgaf:"idgaf.png",flup:"flup.png",eme:"eme_logo.png",tribute:"tribute.png",headbop:"headbop.gif",thunk:"thunk.png",angry:"(.gif",happy:"D.gif",melon:"melon.png",sadgry:"sadgry.png",triggered:"triggered.png",trump:"trump.gif",trumpo:"trumpo.png",ajcry:"ajsad.gif",aj:"alexjones.png",snek:"snek.png",mummy:"mummy.png",metroplier:"metroplier.png",dany:"sorry_hihi.png",smh:"smh.gif",hopsin:"hopsin.png",boolean:"boolean.png",obo:"beholder.png",catlooks:"katzen.png",moth:"moth.png","whoa mama":"whoa_mama.png",wowzors:"wowzors.png",pappa:"pappa.gif"},e.actions={surrender:()=>{fe.request("Game:surrender",{}).then(()=>{gui.dialog("game-end",null)})},draw:()=>{},okcs:()=>{fetch("dev/force_turn",{}).then(e=>e.json()).then(fe.onmessage.bind(fe))},reset:()=>{fetch("dev/reset").then(e=>e.json()).then(e=>{window.location="/"})},killallboomers:()=>{},"i wanna be tracer":()=>{},"kids with guns":()=>{},"ilyesadam bazmeg":()=>{},"and now my order is in YOUR court":()=>{}};try{e.config=n,e.sub()}catch(e){console.error("Chat module failed: ",e)}}(Le.$refs["global-chat"],e.conf.chat):Le.$refs["global-chat"]&&(Le.$refs["global-chat"].show=!1),function(e){z=e}(e.conf.building),ce(!0),init_test(),console.info("Game loaded.")})}]).default}));